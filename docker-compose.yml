version: '3.8'

# This docker-compose file is for Jenkins CI/CD pipeline (Part-II)
# It uses volumes to mount code instead of building from Dockerfile
# Uses different ports and container names than production deployment

services:
  # Backend Service for Jenkins Build
  backend-jenkins:
    # Using official Node.js image instead of building from Dockerfile
    image: node:18-alpine
    container_name: blogging-backend-jenkins
    working_dir: /app
    # Volume mounts code instead of using Dockerfile - REQUIRED BY ASSIGNMENT
    volumes:
      - ./server:/app
      - /app/node_modules
    ports:
      - "5001:5000"  # Different port (5001) for Jenkins build
    environment:
      - PORT=5000
      - DB_URL=${DB_URL}
      - JWT_TOKEN=${JWT_TOKEN}
    command: sh -c "npm install && node index.js"
    restart: always
    networks:
      - jenkins-network

  # Frontend Service for Jenkins Build
  frontend-jenkins:
    # Using Nginx image with volume mount instead of building
    image: nginx:stable-alpine
    container_name: blogging-frontend-jenkins
    # Volume mounts code - REQUIRED BY ASSIGNMENT
    volumes:
      - ./client/dist:/usr/share/nginx/html
      - ./client/nginx-jenkins.conf:/etc/nginx/conf.d/default.conf
    ports:
      - "8081:80"  # Different port (8081) for Jenkins build
    depends_on:
      - backend-jenkins
    restart: always
    networks:
      - jenkins-network

networks:
  jenkins-network:
    driver: bridge